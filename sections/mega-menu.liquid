{% style %}
  {{ section.settings.card_title_font_family | font_face: font_display: 'swap' }}
  {{ section.settings.card_desc_font_family | font_face: font_display: 'swap' }}
  {{ section.settings.product_header_font_family | font_face: font_display: 'swap' }}
{% endstyle %}

<style>
  /* Make mega-menu sticky when inside header-group */
  .header-section:has(+ .mega-menu-section) {
    position: sticky;
    top: -1px;
    z-index: var(--layer-sticky);
  }

  .mega-menu-section {
    position: sticky;
    top: var(--header-height, 0);
    z-index: var(--layer-sticky);
    background-color: #fff;
  }

  /* Main Mega Menu Bar */
  .mega-menu {
    padding: 15px 0;
    border-bottom: 1px solid #e5e5e5;
    border-top: 1px solid #fff;
    position: relative;
    background-color: #fff;
    margin-top: -1px;
  }

  .mega-menu__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .mega-menu__item {
    margin: 0 20px;
    position: static;
  }

  /* Top-level menu links */
  .mega-menu__link {
    position: relative;
    text-decoration: none;
    color: #000;
    font-size: 16px;
    letter-spacing: 0.5px;
    padding-bottom: 8px;
    display: block;
  }

  .mega-menu__link::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background-color: {{ section.settings.underline_color }};
    display: none;
  }

  .mega-menu__item.is-active .mega-menu__link::after {
    display: block;
  }

  /* Dropdown Panel - COMPACT SIZE with smooth transitions */
  .mega-menu__dropdown {
    display: block;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    width: 100%;
    background-color: #fff;
    padding: 30px 5% 40px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    border-top: 1px solid #e5e5e5;
    z-index: 96;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .mega-menu__dropdown.is-visible {
    pointer-events: auto;
    opacity: 1;
    visibility: visible;
  }

  /* Extended hover zone between menu and dropdown */
  .mega-menu__item::before {
    content: '';
    position: absolute;
    top: 100%;
    left: -20px;
    right: -20px;
    height: 20px;
    pointer-events: none;
    z-index: 97;
  }

  .mega-menu__item.is-active::before {
    pointer-events: auto;
  }

  .mega-menu__dropdown-grid {
    display: grid;
    grid-template-columns: minmax(0, 320px) minmax(0, 320px) minmax(0, 260px) minmax(0, 280px);
    gap: 40px;
    max-width: 1300px;
    margin: 0 auto;
  }

  /* 3-column grid for "More" section */
  .mega-menu__dropdown-grid.is-more-section {
    grid-template-columns: minmax(0, 320px) minmax(0, 320px) minmax(0, 280px);
  }
  
  /* Feature Cards - COMPACT SIZE */
  .mega-menu__feature-card {
    display: flex;
    flex-direction: column;
    max-width: 320px;
  }

  .mega-menu__feature-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .mega-menu__feature-card img {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 3;
    object-fit: cover;
    margin-bottom: 12px;
    background-color: #f5f5f5;
  }

  .mega-menu__feature-card-heading {
    font-size: {{ section.settings.card_title_font_size }}px;
    font-weight: {{ section.settings.card_title_font_weight }};
    color: {{ section.settings.card_title_color }};
    text-transform: {{ section.settings.card_title_text_transform }};
    letter-spacing: {{ section.settings.card_title_letter_spacing }}px;
    margin-bottom: 8px;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 4px;
    line-height: 1.3;
    {% if section.settings.card_title_font_family %}
      font-family: {{ section.settings.card_title_font_family.family }}, {{ section.settings.card_title_font_family.fallback_families }};
      font-weight: {{ section.settings.card_title_font_family.weight }};
    {% endif %}
  }

  .mega-menu__feature-card-text {
    font-size: {{ section.settings.card_desc_font_size }}px;
    line-height: 1.4;
    color: {{ section.settings.card_desc_color }};
    font-weight: {{ section.settings.card_desc_font_weight }};
    {% if section.settings.card_desc_font_family %}
      font-family: {{ section.settings.card_desc_font_family.family }}, {{ section.settings.card_desc_font_family.fallback_families }};
      font-weight: {{ section.settings.card_desc_font_family.weight }};
    {% endif %}
  }

  /* Product Links Column */
  .mega-menu__product-links-heading {
    font-size: {{ section.settings.product_header_font_size }}px;
    font-weight: {{ section.settings.product_header_font_weight }};
    color: {{ section.settings.product_header_color }};
    text-transform: {{ section.settings.product_header_text_transform }};
    letter-spacing: {{ section.settings.product_header_letter_spacing }}px;
    margin-bottom: 18px;
    padding-bottom: 6px;
    border-bottom: 2px solid #000;
    display: inline-block;
    {% if section.settings.product_header_font_family %}
      font-family: {{ section.settings.product_header_font_family.family }}, {{ section.settings.product_header_font_family.fallback_families }};
      font-weight: {{ section.settings.product_header_font_family.weight }};
    {% endif %}
  }

  .mega-menu__product-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .mega-menu__product-item a {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #000;
    margin-bottom: 16px;
    font-size: 13px;
    text-transform: uppercase;
    font-weight: bold;
    transition: opacity 0.3s ease;
  }

  .mega-menu__product-item a:hover {
    opacity: 0.7;
  }

  .mega-menu__product-item img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    margin-right: 12px;
    background-color: #f5f5f5;
    flex-shrink: 0;
  }

  /* Quick Links Column */
  .mega-menu__quick-links {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .mega-menu__quick-links a {
    text-decoration: none;
    color: #333;
    font-size: 14px;
    line-height: 2;
    display: block;
    transition: text-decoration 0.3s ease;
  }

  .mega-menu__quick-links a:hover {
    text-decoration: underline;
  }

  /* Update CSS variables for sticky behavior */
  body:has(.mega-menu-section) {
    --mega-menu-height: 52px;
  }

  @media (max-width: 1024px) {
    .mega-menu__dropdown-grid {
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      max-width: 100%;
    }

    .mega-menu__dropdown-grid.is-more-section {
      grid-template-columns: 1fr 1fr;
    }

    .mega-menu__feature-card {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .mega-menu__dropdown {
      padding: 20px 3% 30px;
    }

    .mega-menu__dropdown-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .mega-menu__dropdown-grid.is-more-section {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="mega-menu color-{{ section.settings.color_scheme }}">
  <ul class="mega-menu__list">
    {%- for block in section.blocks -%}
      <li class="mega-menu__item" {{ block.shopify_attributes }} data-menu-item>
        <a href="{{ block.settings.link_url }}" class="mega-menu__link">
          {{ block.settings.link_text }}
        </a>

        {%- if block.settings.show_dropdown -%}
          <div class="mega-menu__dropdown" data-dropdown>
            {%- assign link_text_lower = block.settings.link_text | downcase -%}
            {%- if link_text_lower contains "more" -%}
              {%- assign is_more_section = true -%}
            {%- else -%}
              {%- assign is_more_section = false -%}
            {%- endif -%}
            
            <div class="mega-menu__dropdown-grid{% if is_more_section %} is-more-section{% endif %}">
              
              <!-- Feature Card 1 -->
              <div class="mega-menu__feature-card">
                <a href="{{ block.settings.feature_1_url }}" class="mega-menu__feature-card-link">
                  {%- if block.settings.feature_1_image != blank -%}
                    <img 
                      src="{{ block.settings.feature_1_image | image_url: width: 640 }}" 
                      alt="{{ block.settings.feature_1_image.alt | default: block.settings.feature_1_heading | escape }}"
                      width="320"
                      height="240"
                      loading="lazy"
                    >
                  {%- else -%}
                    <div style="aspect-ratio: 4/3; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                      {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {%- endif -%}
                  <h3 class="mega-menu__feature-card-heading">{{ block.settings.feature_1_heading }}</h3>
                </a>
                <p class="mega-menu__feature-card-text">{{ block.settings.feature_1_text }}</p>
              </div>

              <!-- Feature Card 2 -->
              <div class="mega-menu__feature-card">
                <a href="{{ block.settings.feature_2_url }}" class="mega-menu__feature-card-link">
                  {%- if block.settings.feature_2_image != blank -%}
                    <img 
                      src="{{ block.settings.feature_2_image | image_url: width: 640 }}" 
                      alt="{{ block.settings.feature_2_image.alt | default: block.settings.feature_2_heading | escape }}"
                      width="320"
                      height="240"
                      loading="lazy"
                    >
                  {%- else -%}
                    <div style="aspect-ratio: 4/3; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                      {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {%- endif -%}
                  <h3 class="mega-menu__feature-card-heading">{{ block.settings.feature_2_heading }}</h3>
                </a>
                <p class="mega-menu__feature-card-text">{{ block.settings.feature_2_text }}</p>
              </div>

              {%- if is_more_section -%}
                <!-- For "More" section: Show quick links only (3rd column) -->
                <div>
                  <h3 class="mega-menu__product-links-heading">{{ block.settings.link_text }}</h3>
                  {%- if block.settings.quick_links != blank -%}
                    <ul class="mega-menu__quick-links">
                      {%- for link in block.settings.quick_links.links -%}
                        <li><a href="{{ link.url }}">{{ link.title }}</a></li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}
                </div>
              {%- else -%}
                <!-- For other sections: Show products (3rd column) -->
                <div class="mega-menu__product-links">
                  <h3 class="mega-menu__product-links-heading">{{ block.settings.link_text }}</h3>
                  <ul class="mega-menu__product-list">
                    {% for product in block.settings.featured_products %}
                      <li class="mega-menu__product-item">
                        <a href="{{ product.url }}">
                          {% if product.featured_image != blank %}
                            <img 
                              src="{{ product.featured_image | image_url: width: 100 }}" 
                              alt="{{ product.featured_image.alt | default: product.title | escape }}"
                              width="50"
                              height="50"
                              loading="lazy"
                            >
                          {% else %}
                            <div style="width: 50px; height: 50px; background-color: #f5f5f5; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                            </div>
                          {% endif %}
                          <span>{{ product.title }}</span>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>

                <!-- Fourth Column: Quick Links (only for non-"More" sections) -->
                <div>
                  {%- if block.settings.quick_links != blank -%}
                    <ul class="mega-menu__quick-links">
                      {%- for link in block.settings.quick_links.links -%}
                        <li><a href="{{ link.url }}">{{ link.title }}</a></li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}
                </div>
              {%- endif -%}

            </div>
          </div>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Calculate header height for sticky positioning
    function updateHeaderHeight() {
      const header = document.querySelector('.header-section');
      if (header) {
        const headerHeight = header.offsetHeight;
        document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
      }
    }
    
    updateHeaderHeight();
    window.addEventListener('resize', updateHeaderHeight);
    
    // Update on scroll to handle transparent header changes
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          updateHeaderHeight();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Improved dropdown hover functionality with delay and smooth transitions
    const menuItems = document.querySelectorAll('[data-menu-item]');
    let hideTimeout;
    let currentActiveItem = null;

    menuItems.forEach(item => {
      const dropdown = item.querySelector('[data-dropdown]');
      
      if (!dropdown) return;

      // Mouse enters menu item
      item.addEventListener('mouseenter', function() {
        // Clear any pending hide timeout
        clearTimeout(hideTimeout);
        
        // Hide any currently active dropdown first
        if (currentActiveItem && currentActiveItem !== item) {
          const activeDropdown = currentActiveItem.querySelector('[data-dropdown]');
          if (activeDropdown) {
            activeDropdown.classList.remove('is-visible');
          }
          currentActiveItem.classList.remove('is-active');
        }
        
        // Show current dropdown with smooth transition
        item.classList.add('is-active');
        // Small delay to ensure transition works
        requestAnimationFrame(() => {
          dropdown.classList.add('is-visible');
        });
        currentActiveItem = item;
      });

      // Mouse leaves menu item
      item.addEventListener('mouseleave', function(e) {
        // Get the related target (where mouse is going)
        const relatedTarget = e.relatedTarget;
        
        // Check if mouse is entering the dropdown or staying within the menu item
        if (dropdown.contains(relatedTarget) || item.contains(relatedTarget)) {
          return; // Don't hide if moving to dropdown
        }
        
        // Add delay before hiding
        hideTimeout = setTimeout(() => {
          dropdown.classList.remove('is-visible');
          item.classList.remove('is-active');
          if (currentActiveItem === item) {
            currentActiveItem = null;
          }
        }, 400); // 400ms delay
      });

      // Mouse enters dropdown - cancel hide and ensure visibility
      dropdown.addEventListener('mouseenter', function(e) {
        clearTimeout(hideTimeout);
        // Ensure the dropdown stays visible
        dropdown.classList.add('is-visible');
        item.classList.add('is-active');
        
        // Prevent event from bubbling
        e.stopPropagation();
      });

      // Mouse leaves dropdown
      dropdown.addEventListener('mouseleave', function(e) {
        // Check if mouse is going back to the menu item
        const relatedTarget = e.relatedTarget;
        if (item.contains(relatedTarget)) {
          return; // Don't hide if going back to menu item
        }
        
        // Hide with delay
        hideTimeout = setTimeout(() => {
          dropdown.classList.remove('is-visible');
          item.classList.remove('is-active');
          if (currentActiveItem === item) {
            currentActiveItem = null;
          }
        }, 200); // Shorter delay when leaving dropdown
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const isMenuClick = e.target.closest('[data-menu-item]');
      if (!isMenuClick && currentActiveItem) {
        const activeDropdown = currentActiveItem.querySelector('[data-dropdown]');
        if (activeDropdown) {
          activeDropdown.classList.remove('is-visible');
        }
        currentActiveItem.classList.remove('is-active');
        currentActiveItem = null;
      }
    });
  });
</script>

{% schema %}
{
  "name": "Mega Menu",
  "tag": "section",
  "class": "mega-menu-section",
  "max_blocks": 8,
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "color",
      "id": "underline_color",
      "label": "Hover Underline Color",
      "default": "#E7237E"
    },
    {
      "type": "header",
      "content": "Card Title Typography"
    },
    {
      "type": "font_picker",
      "id": "card_title_font_family",
      "label": "Font Family",
      "default": "assistant_n4"
    },
    {
      "type": "range",
      "id": "card_title_font_size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Font Size",
      "default": 13
    },
    {
      "type": "select",
      "id": "card_title_font_weight",
      "label": "Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" },
        { "value": "800", "label": "Extra Bold" }
      ],
      "default": "700"
    },
    {
      "type": "select",
      "id": "card_title_text_transform",
      "label": "Text Transform",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "uppercase", "label": "Uppercase" },
        { "value": "lowercase", "label": "Lowercase" },
        { "value": "capitalize", "label": "Capitalize" }
      ],
      "default": "uppercase"
    },
    {
      "type": "range",
      "id": "card_title_letter_spacing",
      "min": 0,
      "max": 3,
      "step": 0.1,
      "unit": "px",
      "label": "Letter Spacing",
      "default": 0.5
    },
    {
      "type": "color",
      "id": "card_title_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Card Description Typography"
    },
    {
      "type": "font_picker",
      "id": "card_desc_font_family",
      "label": "Font Family",
      "default": "assistant_n4"
    },
    {
      "type": "range",
      "id": "card_desc_font_size",
      "min": 10,
      "max": 18,
      "step": 1,
      "unit": "px",
      "label": "Font Size",
      "default": 13
    },
    {
      "type": "select",
      "id": "card_desc_font_weight",
      "label": "Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "400"
    },
    {
      "type": "color",
      "id": "card_desc_color",
      "label": "Text Color",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Product Header Typography"
    },
    {
      "type": "font_picker",
      "id": "product_header_font_family",
      "label": "Font Family",
      "default": "assistant_n4"
    },
    {
      "type": "range",
      "id": "product_header_font_size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Font Size",
      "default": 13
    },
    {
      "type": "select",
      "id": "product_header_font_weight",
      "label": "Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semibold" },
        { "value": "700", "label": "Bold" },
        { "value": "800", "label": "Extra Bold" }
      ],
      "default": "700"
    },
    {
      "type": "select",
      "id": "product_header_text_transform",
      "label": "Text Transform",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "uppercase", "label": "Uppercase" },
        { "value": "lowercase", "label": "Lowercase" },
        { "value": "capitalize", "label": "Capitalize" }
      ],
      "default": "uppercase"
    },
    {
      "type": "range",
      "id": "product_header_letter_spacing",
      "min": 0,
      "max": 3,
      "step": 0.1,
      "unit": "px",
      "label": "Letter Spacing",
      "default": 0.5
    },
    {
      "type": "color",
      "id": "product_header_color",
      "label": "Text Color",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "menu_item",
      "name": "Menu Item",
      "settings": [
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "default": "Menu Item"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        },
        {
          "type": "header",
          "content": "Dropdown Content"
        },
        {
          "type": "checkbox",
          "id": "show_dropdown",
          "label": "Show dropdown on hover",
          "default": false
        },
        {
          "type": "header",
          "content": "Feature Card 1"
        },
        {
          "type": "image_picker",
          "id": "feature_1_image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "feature_1_heading",
          "label": "Heading",
          "default": "Feature Heading"
        },
        {
          "type": "textarea",
          "id": "feature_1_text",
          "label": "Text",
          "default": "Describe the feature or promotion."
        },
        {
          "type": "url",
          "id": "feature_1_url",
          "label": "Link URL"
        },
        {
          "type": "header",
          "content": "Feature Card 2"
        },
        {
          "type": "image_picker",
          "id": "feature_2_image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "feature_2_heading",
          "label": "Heading",
          "default": "Feature Heading"
        },
        {
          "type": "textarea",
          "id": "feature_2_text",
          "label": "Text",
          "default": "Describe the feature or promotion."
        },
        {
          "type": "url",
          "id": "feature_2_url",
          "label": "Link URL"
        },
        {
          "type": "header",
          "content": "Product & Quick Links"
        },
        {
          "type": "product_list",
          "id": "featured_products",
          "label": "Featured Products",
          "limit": 5
        },
        {
          "type": "link_list",
          "id": "quick_links",
          "label": "Quick Links"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Mega Menu",
      "blocks": [
        { "type": "menu_item", "settings": { "link_text": "Shop All" } },
        { "type": "menu_item", "settings": { "link_text": "Face" } },
        { "type": "menu_item", "settings": { "link_text": "Eyes" } },
        { "type": "menu_item", "settings": { "link_text": "Lips" } }
      ]
    }
  ]
}
{% endschema %}